<!-- vibeguard-start -->
# VibeGuard — AI 辅助开发防幻觉规则

> 以下规则由 VibeGuard 管理，自动追加到全局 CLAUDE.md。
> 仓库：~/Desktop/code/AI/tools/vibeguard/
> 完整规范：vibeguard/spec.md

## 防幻觉七层框架（精简执行版）

### Layer 1: 先搜后写（反重复）

- **新建文件/类/Protocol/函数前，必须先搜索项目中是否已有类似功能**
- 新建文件/类前，必须调用 `mcp__vibeguard__guard_check(guard=duplicates)` 验证无重复
- 已有就扩展，不新建
- 跨模块共享的接口放 `core/interfaces/`，工具函数放 `core/`
- 第 1 次直接写，第 2 次容忍重复，第 3 次提取公共代码
- 不要创建 archive 目录，旧版本用 git 管理

### Layer 2: 命名约束

- Python 内部一律 snake_case，API 边界 camelCase
- 入口 `snakeize_obj()`，出口 `camelize_obj()`
- 禁止函数/类别名（一个函数只能有一个名字）
- 不要做向后兼容的重命名 shim

### Layer 3: 代码质量基线

- `except Exception` 必须有 logging 或 re-raise，禁止静默吞异常
- Facade 公开方法禁止 `Any` 类型参数/返回值
- API schema 文件必须包含实际定义，不能只有 re-export
- Application/workflow 层禁止访问其他模块的 `_private` 属性

### Layer 4: 数据真实性

- 没有数据就显示空白，不要用假数据/示例数据/placeholder
- 不要硬编码内容（端口、URL、配置值、文案等），prompt 例外
- 所有内容必须来自数据源或 AI 生成，不凭空捏造
- 不要发明不存在的 API、字段名、文件路径

### Layer 5: 最小改动原则

- 只做被要求的事，不添加额外"改进"
- 不加 docstring、注释、type annotations 到未修改的代码
- 不加 error handling 给不可能发生的场景
- 不创建 helpers/utilities/abstractions 给一次性操作
- 不设计假想的未来需求
- 三行相似代码比过早抽象好

### Layer 6: 执行流程约束

- **重大修改前（3+ 文件、新入口、数据层变更）先运行 `/vibeguard:preflight` 生成约束集**
- 修改前先完整了解系统，分析后再动手
- 复杂功能（3+ 文件或架构变更）先写 spec 再实现
- 每个修复必须带对应的测试
- 使用 todolist/子 agent 分解复杂任务
- 继续执行任务，不用每步都问确认
- 修改过程中/完成后运行 `/vibeguard:check` 验证守卫基线未恶化
- 任务完成前，调用 `mcp__vibeguard__compliance_report` 确认合规
- 可用守卫工具：`mcp__vibeguard__guard_check`、`mcp__vibeguard__compliance_report`、`mcp__vibeguard__metrics_collect`
- 可用命令：`/vibeguard:preflight`（预防）、`/vibeguard:check`（验证）

#### 守卫修复流程

当 `guard_check` 发现问题时，按以下流程处理：

1. **分析发现**：按守卫类型和文件分组，评估影响范围
2. **读取规则**：读取 vibeguard/workflows/auto-optimize/rules/ 下对应语言的规则文件，了解 FIX/SKIP/DEFER 判断标准和修复模式
3. **生成修复计划**：基于发现和项目上下文，为每组问题决定：
   - FIX：立即修复，给出具体修改方案
   - SKIP：说明跳过原因
   - DEFER：说明推迟原因，记录到 backlog
4. **执行修复**：按优先级逐项修复（high → medium → low），每个 fix 独立 commit
5. **验证**：修复后重新运行 `guard_check` 确认问题已解决

修复优先级：逻辑 bug > 重复类型 > unwrap/expect > 命名规范

### Layer 7: 提交纪律

- 禁止附带 `Generated by Claude`、`Co-Authored-By` 或任何 AI 生成标记
- PR 描述简短
- 不要强制推送（force push）
- 不要 inline import
- 不要带任何密钥/敏感信息提交
- 不要做任何向后兼容：直接删除旧代码

## 自检清单

每次编写代码前，自动检查：

```
□ 搜索过项目中是否已有类似功能？
□ 使用的数据字段名确实存在于数据源中？
□ Python 内部使用 snake_case？
□ 没有创建函数/类别名？
□ 没有硬编码内容？
□ 没有添加不必要的"改进"？
□ 有对应的测试？
□ 新建文件前调用了 guard_check(guard=duplicates)？
□ 任务完成前调用了 compliance_report？
```

## 违规响应

| 违规类型 | 响应 |
|----------|------|
| 不搜索就新建 | 立即搜索，如有现存实现则改为扩展 |
| 使用 camelCase | 改为 snake_case，在边界用转换函数 |
| 创建别名 | 选择一个规范名，全局替换 |
| 硬编码内容 | 改为从数据/配置获取 |
| 添加向后兼容 | 直接删除旧代码 |
| 过度设计 | 删除多余抽象，保持最小实现 |
<!-- vibeguard-end -->
