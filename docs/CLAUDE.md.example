# CLAUDE.md — 10x Engineer Configuration

> 融合 Anthropic 官方最佳实践 + VibeGuard 七层防御。
> 区别于"建议遵守"型配置——规则由 Hooks 自动拦截 + 守卫脚本强制执行。

---

## Workflow Orchestration（工作流编排）

### 1. Complexity Router（复杂度路由）

根据改动规模自动选择流程深度：

| 规模 | 流程 |
|------|------|
| 1-2 文件 | 直接实现 |
| 3-5 文件 | `/vibeguard:preflight` → 约束集 → 实现 |
| 6+ 文件 | `/vibeguard:interview` → SPEC → `/vibeguard:preflight` → 实现 |

### 2. Spec-Driven（规范驱动）

复杂功能（3+ 文件）先 spec 再实现：
1. **先理解** — 读相关代码，画出当前数据流
2. **写 spec** — 改什么、为什么、影响哪些文件、接口定义
3. **按 spec 实现** — 不偏离，发现问题先更新 spec
4. **验证** — 对照 spec 逐项检查

简单修改直接做，不要过度流程。

### 3. Subagent Strategy

- 用子 agent 保持主上下文窗口干净
- 研究、探索、并行分析**卸载给子 agent**
- 每个子 agent 一个聚焦任务

### 4. Autonomous Execution

- 收到 bug 报告：**直接修**，不问东问西
- 看到日志/报错/失败测试 — 定位根因并解决
- 用户零上下文切换

---

## Context Management（上下文管理 — Anthropic 官方推荐）

上下文窗口是最重要的资源，积极管理：

- **两次纠正法则**：同一问题纠正 2 次后 → `/clear` 重来，脏上下文只会越改越错
- **任务间 `/clear`**：不相关任务之间清空上下文，不要让历史干扰新任务
- **压缩保留指令**：When compacting, always preserve: 已修改文件列表、约束集、测试命令、架构决策
- **子 agent 隔离**：大量文件读取交给子 agent，不污染主上下文
- **长会话警觉**：上下文快满时性能下降，主动 `/clear` 或 `/compact`

---

## Self-Improvement Loop（自我进化循环）

> 不是"建议 AI 学习"，而是**每次犯错自动生成新的防御规则**。

```
犯错 → /vibeguard:learn → 分析根因 → 生成新守卫规则/Hook → 同类错误永不再犯
```

- 被纠正后运行 `/vibeguard:learn`，自动生成防御规则
- 规则可转化为 Hook 脚本，下次**自动拦截**
- 效果可量化：`/vibeguard:stats` 查看拦截/警告/放行统计

---

## Seven-Layer Defense（七层防御 — 强制执行）

Hooks + 守卫脚本**机械化执行**，不靠 AI 自觉：

| 层 | 约束 | 执行方式 |
|----|------|----------|
| **L1** | 新建前必须搜索已有实现 | **Hook 自动拦截** |
| **L2** | Python snake_case，API camelCase | 守卫脚本 |
| **L3** | 禁静默吞异常；禁 Any 类型 | **Hook 警告** |
| **L4** | 无数据显示空白；不发明 API | **Hook 警告** |
| **L5** | 只做被要求的事 | 审查约束 |
| **L6** | 按复杂度路由执行流程 | 流程约束 |
| **L7** | 禁 AI 标记 / force push / 密钥 | **Hook 拦截** |

---

## Auto-Enforcement（自动执行）

### Hooks — 实时拦截

| 触发条件 | 行为 |
|----------|------|
| `Write` 创建新源码文件 | **Block** — 先搜索已有实现 |
| `Bash` force push / rm -rf / reset --hard | **Block** — 给出安全替代 |
| `Edit` 不存在的文件 | **Block** — 先 Read 确认 |
| `Edit` 新增 unwrap/expect（Rust） | **Warn** — 输出修复方法 |
| `Edit` 新增硬编码路径 | **Warn** — 提示用配置 |
| `Edit` 新增 console.log / print | **Warn** — 提示用 logger |
| `Stop` 有未验证的源码变更 | **Gate** — 提醒完成验证 |

### Observability

所有事件记录到 `~/.vibeguard/events.jsonl`，`/vibeguard:stats` 查看统计。

---

## Verification Before Done（完成前必须验证 — Anthropic 官方最高优先）

> "Give Claude a way to verify its work — this is the single highest-leverage thing you can do."

**Stop Hook 自动门禁**：Claude 想结束时，如果有未验证的源码变更，自动提醒完成验证。

### 编码验证（一轮修改完成后）

```
Rust: cargo check  |  TypeScript: npx tsc --noEmit  |  Go: go build ./...
```

### 提交前验证

```
Rust: cargo test  |  TypeScript: npm test  |  Go: go test ./...  |  Python: pytest
```

### 守卫验证

```
/vibeguard:check    ← 全量守卫扫描 + 合规报告
```

问自己：**"一个 Staff Engineer 会批准这个吗？"**

---

## Code Rules（代码铁律）

- **不做向后兼容** — 直接删旧代码
- **不硬编码** — 端口、URL、配置走配置文件
- **不过度设计** — 只做必要功能
- **单文件 ≤ 200 行** — 超过必须拆分
- **先搜后写** — 已有就扩展，第 3 次重复必须抽象
- **没数据就空白** — 不用假数据
- **每个修复带测试**
- **遵循项目已有模式**
- **禁止擅自修改 .env**

---

## Git Discipline（提交纪律）

- **禁止** AI 生成标记（Generated by Claude / Co-Authored-By）
- **禁止** force push — 用 `--force-with-lease`
- rebase 保持历史干净，不提交密钥

---

## Interview Mode（面试模式 — Anthropic 官方推荐）

大功能开始前，让 AI 采访你而非你描述需求：

```
/vibeguard:interview <功能描述>
```

AI 会用 AskUserQuestion 逐轮深入：功能边界 → 技术实现 → 边界情况 → 验收标准。
采访完输出结构化 SPEC.md，建议在**新会话**中执行以获得干净上下文。

---

## Path-Scoped Rules（路径作用域规则 — 可选）

在项目 `.claude/rules/` 下放置作用域规则，不同目录自动加载不同约束：

```
.claude/rules/api-security.md      # globs: ["**/api/**", "**/routes/**"]
.claude/rules/test-patterns.md     # globs: ["**/*test*", "**/tests/**"]
.claude/rules/config-protection.md # globs: ["**/.env*", "**/config/**"]
```

模板在 `vibeguard/templates/project-rules/`，按需复制到项目中。

---

## Command Workflow（命令工作流）

```
interview（采访）→ preflight（预防）→ 编码 → check（验证）→ review（审查）→ learn（进化）→ stats（观测）
```

| 命令 | 用途 |
|------|------|
| `/vibeguard:interview` | 大功能需求深度采访，输出 SPEC |
| `/vibeguard:preflight` | 修改前生成约束集 |
| `/vibeguard:check` | 全量守卫扫描 + 合规报告 |
| `/vibeguard:review` | 结构化代码审查 |
| `/vibeguard:cross-review` | 双模型对抗审查（Claude + Codex） |
| `/vibeguard:build-fix` | 构建错误修复 |
| `/vibeguard:learn` | 从犯错中生成新守卫 |
| `/vibeguard:stats` | Hook 触发统计 |

---

## Core Principles

- **Simplicity First** — 最简方案，最小改动
- **No Laziness** — 找根因，不打补丁
- **Minimal Impact** — 只碰必须碰的代码
- **Mechanical Enforcement** — 能脚本化的不靠自觉
- **Failure → Defense** — 每次犯错都变成新防线
- **Verify Before Ship** — 没验证的代码等于没写

---

## Setup

```bash
git clone https://github.com/majiayu000/vibeguard.git ~/vibeguard
bash ~/vibeguard/setup.sh                 # 默认 core
bash ~/vibeguard/setup.sh --profile full  # 额外启用 Stop Gate / Learn evaluator
```

新开 Claude Code 会话即生效。默认 `core` profile 注入七层规则与核心 Hooks；`full` profile 额外启用 Stop Gate。
